---
title: "p8105_hw5_lg3239"
author: "Landi Guo"
date: "2022-11-13"
output: github_document
editor_options: 
  chunk_output_type: inline
---

```{r}
library(tidyverse)
library(stringr)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 2
```{r}
wp = read_csv("hw5_files/homicide-data.csv")
```
The raw data contains `r ncol(wp)` columns and `r nrow(wp)` rows with each row representing a homicide case. Variables include reported date, demographic identifiers for the victim, location of killing, and whether an arrest was made. The variables are `r names(wp)`. These homicides happened in `r wp%>%select(city)%>%distinct%>%count` cities in America. The victim's age ranges from `r wp%>%min(victim_age)` to `r wp%>%max(victim_age)`.

`city_total` object contains the dataframe with columns `city_state` and `total_h`, the number of total homicides happened in each city. `city_unsolve`object contains the dataframe with columns `city_state` and `unsolved_h`, the number of total unsolved homicides happened in each city. Since the number of columns differs in these two dataframes, I found the missing city using logical operations and added this missing city with total of 0 in `city_unsolve`. Lastly, joining the two dataframes into `city_prop`, using `full_join`.
```{r}
city_total = 
  wp %>%
  mutate(city_state = str_c(city, ", ", state)) %>%
  group_by(city_state) %>%
  summarise(total_h = n()) %>%
  mutate(total_h = as.numeric(total_h))

city_unsolve = 
  wp %>%
  mutate(city_state = str_c(city, ", ", state)) %>%
  filter(disposition %in% c("Closed without arrest", "Open/No arrest")) %>%
  group_by(city_state) %>%
  summarise(unsolved_h = n()) 

missing_city = pull(city_total, city_state)[!pull(city_total, city_state) %in% pull(city_unsolve, city_state)]

city_unsolve = rbind(city_unsolve, c(missing_city, 0)) %>%
  mutate(unsolved_h = as.numeric(unsolved_h))

city_prop = full_join(city_unsolve, city_total)
city_prop
```
Conduct `prop.test` on Baltimore's data.
```{r}
baltimore_prop = prop.test(x = 1825, n = 2827)
baltimore_prop %>%
  broom::tidy() %>%
  select(estimate, conf.low, conf.high)
```

Conduct `prop.test` on each city in `city_prop`. Use `map2` on `unsolved_h` and `total_h` to perform prop.test, resulting in list columns `ptest`. Use `broom::tidy` on `ptest`. Select desired result columns within `ptest` and `unnest` it. Remove unwanted columns.
```{r}
city_test =
  city_prop %>%
  mutate(ptest = map2(.x = unsolved_h, .y = total_h, ~prop.test(x = .x, n = .y))) %>%
  mutate(ptest = map(ptest, broom::tidy)) %>%
  mutate(ptest = map(ptest, ~select(., estimate, conf.low, conf.high))) %>%
  unnest(ptest) %>%
  select(-unsolved_h, -total_h)
city_test
```

This plot shows the estimated proportion of each city with its confidence interval.
```{r}
city_test %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point(size = 0.7) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    x = "City, State",
    y = "Proportion of unsolved",
    title = "Estimated proportion of unsolved homicides for each city"
  )
```

## Problem 3
```{r}
mu_p_model = function(mu, n = 30, sigma = 5) {
  outputlist = vector("list", length = 5000)
  for (i in 1:5000) {
    dist = rnorm(n = n, mean = mu, sd = sigma)
    result = 
      t.test(dist, mu = mu) %>% 
      broom::tidy() %>% 
      select(estimate, p.value)
    outputlist[[i]] = result
  }
  tibble(mu = mu, result = outputlist) %>%
    unnest(result)
}

```

```{r}
df = mu_p_model(0)
for (i in 1:6) {
  df_temp = mu_p_model(i)
  df = bind_rows(df, df_temp)
}

reject_df = 
  df %>%
  filter(p.value < 0.05) %>%
  group_by(mu) %>%
  summarise(rej_prop = n()/5000,
            rej_mu_hat = mean(estimate))

result_df = 
  df %>%
  group_by(mu) %>%
  summarise(mu_hat = mean(estimate))

comb_df = full_join(reject_df, result_df)

```

```{r}
comb_df
```


```{r}
reject_df %>%
  ggplot(aes(x = mu, y = rej_prop)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE)
```

```{r}
comb_df %>%
  ggplot(aes(x = mu)) +
  geom_point(aes(y = mu_hat, color = "blue")) +
  geom_point(aes(y = rej_mu_hat, color = 'red')) +
  scale_colour_manual(name = "estimate",
                     labels = c("mu_hat", "reject_mu_hat"),
                     values = c(blue = "blue", red = "red")) +
  labs(
    x = "mu",
    y = "estimate"
  )
```
